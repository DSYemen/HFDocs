# ØªØ³Ø±ÙŠØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ONNX Runtime 

ÙŠØ¯Ù…Ø¬ Optimum ONNX Runtime Training Ù…Ù† Ø®Ù„Ø§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© ØªØ·Ø¨ÙŠÙ‚Ø§Øª `ORTTrainer` Ø§Ù„ØªÙŠ ØªÙˆØ³Ø¹ `Trainer` ÙÙŠ [Transformers](https://huggingface.co/docs/transformers/index).

Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„ØªÙˆØ³ÙŠØ¹ØŒ ÙŠÙ…ÙƒÙ† ØªÙ‚Ù„ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ø£ÙƒØ«Ø± Ù…Ù† 35% Ù„Ù„Ø¹Ø¯ÙŠØ¯ Ù…Ù† Ù†Ù…Ø§Ø°Ø¬ Hugging Face Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ PyTorch ÙÙŠ ÙˆØ¶Ø¹ eager.

ØªØ³Ù‡Ù„ ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª [`ORTTrainer`] Ùˆ [`ORTSeq2SeqTrainer`] ØªÙƒÙˆÙŠÙ† __[ONNX Runtime (ORT)](https://onnxruntime.ai/)__ Ù…Ø¹ Ù…ÙŠØ²Ø§Øª Ø£Ø®Ø±Ù‰ ÙÙŠ [`Trainer`](https://huggingface.co/docs/transformers/main_classes/trainer).

ÙˆÙ‡ÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ù„Ù‚Ø© ØªØ¯Ø±ÙŠØ¨ ÙˆØ­Ù„Ù‚Ø© ØªÙ‚ÙŠÙŠÙ… ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ù…ÙŠØ²Ø§ØªØŒ ÙˆØªØ¯Ø¹Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§ØªØŒ ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù…Ø®ØªÙ„Ø·Ø©ØŒ ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ÙˆØ²Ø¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ù…Ù† [NVIDIA](https://techcommunity.microsoft.com/t5/ai-machine-learning-blog/accelerate-pytorch-transformer-model-training-with-onnx-runtime/ba-p/2540471)

Ùˆ [AMD](https://cloudblogs.microsoft.com/opensource/2021/07/13/onnx-runtime-release-1-8-1-previews-support-for-accelerated-training-on-amd-gpus-with-the-amd-rocm-open-software-platform/) GPUs.

Ù…Ø¹ backend ONNX RuntimeØŒ ØªØ³ØªÙÙŠØ¯ [`ORTTrainer`] Ùˆ [`ORTSeq2SeqTrainer`] Ù…Ù†:

* ØªØ­Ø³ÙŠÙ† Ø±Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: Ø·ÙŠ Ø§Ù„Ø«ÙˆØ§Ø¨ØªØŒ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù‚Ø¯ØŒ ÙˆØ§Ù†Ø¯Ù…Ø§Ø¬ Ø§Ù„Ø¹Ù‚Ø¯
* Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„ÙØ¹Ø§Ù„ Ù„Ù„Ø°Ø§ÙƒØ±Ø©
* ØªØ­Ø³ÙŠÙ† kernel
* Ù…Ø­Ø³Ù† Adam Ø§Ù„Ù…Ù†Ø¯Ù…Ø¬ ÙÙŠ ORT: ÙŠØ¬Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª elementwise Ø§Ù„Ù…Ø·Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ù…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø£Ùˆ Ø¨Ø¶Ø¹ Ø¹Ù…Ù„ÙŠØ§Øª Ø¥Ø·Ù„Ø§Ù‚ kernel
* Ù…Ø­Ø³Ù† FP16 Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø©: ÙŠÙ„ØºÙŠ Ø¹Ø¯Ø¯Ù‹Ø§ ÙƒØ¨ÙŠØ±Ù‹Ø§ Ù…Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ù†Ø³Ø® Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¶ÙŠÙ
* Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù…Ø®ØªÙ„Ø·Ø©

Ø¬Ø±Ø¨Ù‡Ø§ Ù„ØªØ­Ù‚ÙŠÙ‚ __Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„ÙƒÙ…ÙˆÙ†ØŒ ÙˆØ³Ø±Ø¹Ø© Ø£Ø¹Ù„Ù‰ØŒ ÙˆØ­Ø¬Ù… Ø¯ÙØ¹Ø© Ù‚ØµÙˆÙ‰ Ø£ÙƒØ¨Ø±__ Ø£Ø«Ù†Ø§Ø¡ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙÙŠ ğŸ¤— Transformers!

## Ø§Ù„Ø£Ø¯Ø§Ø¡

ÙŠÙˆØ¶Ø­ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø£Ø¯Ù†Ø§Ù‡ ØªØ³Ø±ÙŠØ¹Ù‹Ø§ Ù…Ø«ÙŠØ±Ù‹Ø§ Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨ __Ù…Ù† 39% Ø¥Ù„Ù‰ 130%__ Ù„Ù†Ù…Ø§Ø°Ø¬ Hugging Face Ù…Ø¹ Optimum Ø¹Ù†Ø¯ __Ø§Ø³ØªØ®Ø¯Ø§Ù… ONNX Runtime Ùˆ DeepSpeed ZeRO Stage 1__ Ù„Ù„ØªØ¯Ø±ÙŠØ¨.

ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ù„Ù‰ Ù†Ù…Ø§Ø°Ø¬ Hugging Face Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø¹ PyTorch ÙƒØ®Ø· Ø£Ø³Ø§Ø³ØŒ Ùˆ ONNX Runtime ÙÙ‚Ø· Ù„Ù„ØªØ¯Ø±ÙŠØ¨ ÙƒØªØ´ØºÙŠÙ„ Ø«Ø§Ù†ÙØŒ Ùˆ ONNX

Runtime + DeepSpeed ZeRO Stage 1 ÙƒØªØ´ØºÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØŒ Ù…Ù…Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…ÙƒØ§Ø³Ø¨ Ø§Ù„Ù‚ØµÙˆÙ‰. ÙƒØ§Ù† Ø§Ù„Ù…Ø­Ø³Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ´ØºÙŠÙ„ Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ PyTorch Ù‡Ùˆ Ù…Ø­Ø³Ù† AdamW ÙˆÙ…Ø­Ø³Ù†Ø§Øª ORT Training

ØªØ³ØªØ®Ø¯Ù… Ù…Ø­Ø³Ù† Adam Ø§Ù„Ù…Ù†Ø¯Ù…Ø¬ (Ø§Ù„Ù…ØªØ§Ø­ ÙÙŠ `ORTTrainingArguments`). ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù„Ù‰ Ø¹Ù‚Ø¯Ø© Nvidia A100 ÙˆØ§Ø­Ø¯Ø© Ù…Ø¹ 8 ÙˆØ­Ø¯Ø§Øª Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³ÙˆÙ…ÙŠØ©.

<figure class="image table text-center m-0 w-full">
<img src="https://huggingface.co/datasets/optimum/documentation-images/resolve/main/onnxruntime/onnxruntime-training-benchmark.png" alt="ONNX Runtime Training Benchmark"/>
</figure>

Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ØªØ´ØºÙŠÙ„Ø§Øª Ù‡ÙŠ ÙƒÙ…Ø§ ÙŠÙ„ÙŠ:

```
PyTorch: 1.14.0.dev20221103+cu116; ORT: 1.14.0.dev20221103001+cu116; DeepSpeed: 0.6.6; HuggingFace: 4.24.0.dev0; Optimum: 1.4.1.dev0; Cuda: 11.6.2
```

## Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©

Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ONNX Runtime Ù„Ù„ØªØ¯Ø±ÙŠØ¨ØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¬Ù‡Ø§Ø² Ø¨Ù‡ ÙˆØ­Ø¯Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³ÙˆÙ…Ø§Øª (GPU) ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ù† NVIDIA Ø£Ùˆ AMD.

Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… `ORTTrainer` Ø£Ùˆ `ORTSeq2SeqTrainer`ØŒ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ«Ø¨ÙŠØª ÙˆØ­Ø¯Ø© Ù†Ù…Ø·ÙŠØ© ONNX Runtime Training Ùˆ Optimum.

### ØªØ«Ø¨ÙŠØª ONNX Runtime

Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ¦Ø©ØŒ Ù†ÙˆØµÙŠ Ø¨Ø´Ø¯Ø© Ø¨ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Docker Ù„Ø¶Ù…Ø§Ù† ØµØ­Ø© Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª ÙˆØªÙƒÙˆÙŠÙ†Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„ÙØ§Øª docker Ù…Ø¹ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø®ØªÙ„ÙØ© [Ù‡Ù†Ø§](https://github.com/huggingface/optimum/tree/main/examples/onnxruntime/training/docker).

#### Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù„Ù€ NVIDIA GPU

ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ù†Ø£Ø®Ø° ØªØ«Ø¨ÙŠØª `onnxruntime-training 1.14.0` ÙƒÙ…Ø«Ø§Ù„:

* Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ ØªØ«Ø¨ÙŠØª `onnxruntime-training 1.14.0` Ø¹Ø¨Ø± [Dockerfile](https://github.com/huggingface/optimum/blob/main/examples/onnxruntime/training/docker/Dockerfile-ort1.14.0-cu116):

```bash
docker build -f Dockerfile-ort1.14.0-cu116 -t ort/train:1.14.0 .
```

* Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ÙÙŠ Ø¨ÙŠØ¦Ø© Python Ø§Ù„Ù…Ø­Ù„ÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª pip Ø¨Ù…Ø¬Ø±Ø¯ ØªØ«Ø¨ÙŠØª [CUDA 11.6](https://docs.nvidia.com/cuda/archive/11.6.2/) Ùˆ [cuDNN 8](https://developer.nvidia.com/cudnn) Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯.

```bash
pip install onnx ninja
pip install torch==1.13.1+cu116 torchvision==0.14.1 -f https://download.pytorch.org/whl/cu116/torch_stable.html
pip install onnxruntime-training==1.14.0 -f https://download.onnxruntime.ai/onnxruntime_stable_cu116.html
pip install torch-ort
pip install --upgrade protobuf==3.20.2
```

ÙˆÙ‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª:

```bash
python -m torch_ort.configure
```

#### Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù„Ù€ AMD GPU

ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ù†Ø£Ø®Ø° ØªØ«Ø¨ÙŠØª `onnxruntime-training` nightly ÙƒÙ…Ø«Ø§Ù„:

* Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ ØªØ«Ø¨ÙŠØª `onnxruntime-training` Ø¹Ø¨Ø± [Dockerfile](https://github.com/huggingface/optimum/blob/main/examples/onnxruntime/training/docker/Dockerfile-ort-nightly-rocm57):

```bash
docker build -f Dockerfile-ort-nightly-rocm57 -t ort/train:nightly .
```

* Ø¥Ø°Ø§ ÙƒÙ†Øª ØªØ±ÙŠØ¯ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª ÙÙŠ Ø¨ÙŠØ¦Ø© Python Ø§Ù„Ù…Ø­Ù„ÙŠØ©. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª pip Ø¨Ù…Ø¬Ø±Ø¯ ØªØ«Ø¨ÙŠØª [ROCM 5.7](https://rocmdocs.amd.com/en/latest/deploy/linux/quick_start.html) Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯.

```bash
pip install onnx ninja
pip3 install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/rocm5.7
pip install pip install --pre onnxruntime-training -f https://download.onnxruntime.ai/onnxruntime_nightly_rocm57.html
pip install torch-ort
pip install --upgrade protobuf==3.20.2
```

ÙˆÙ‚Ù… Ø¨ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª:

```bash
python -m torch_ort.configure
```

### ØªØ«Ø¨ÙŠØª Optimum

ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Optimum Ø¹Ø¨Ø± pypi:

```bash
pip install optimum
```

Ø£Ùˆ ØªØ«Ø¨ÙŠØªÙ‡ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø±:

```bash
pip install git+https://github.com/huggingface/optimum.git
```

ØªØ«Ø¨Øª Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù€ OptimumØŒ ÙˆØ§Ù„Ø°ÙŠ Ù‚Ø¯ ÙŠØªØ¶Ù…Ù† Ø£Ø­Ø¯Ø« Ø§Ù„ØªØ·ÙˆØ±Ø§Øª (Ù…ÙŠØ²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡). ÙˆÙ…Ø¹ Ø°Ù„ÙƒØŒ Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù…Ø³ØªÙ‚Ø±Ù‹Ø§ Ø¬Ø¯Ù‹Ø§. Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡ØªÙƒ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©ØŒ ÙŠØ±Ø¬Ù‰ ÙØªØ­ [Ù‚Ø¶ÙŠØ©](https://github.com/huggingface/optimum/issues) Ø­ØªÙ‰

ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†.

## ORTTrainer

ØªØ±Ø« ÙØ¦Ø© [`ORTTrainer`] ÙØ¦Ø© [`Trainer`](https://huggingface.co/docs/transformers/main/en/main_classes/trainer#trainer)

Ù…Ù† Transformers. ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© ØªÙƒÙŠÙŠÙ Ø§Ù„Ø±Ù…ÙˆØ² Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ `Trainer` Ù…Ù† transformers Ø¨Ù€ `ORTTrainer` Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ø§Ù„ØªØ³Ø±ÙŠØ¹

Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ù…Ù† ONNX Runtime. ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… `ORTTrainer` Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ `Trainer`:

```diff
-from transformers import Trainer, TrainingArguments
+from optimum.onnxruntime import ORTTrainer, ORTTrainingArguments

# Step 1: Define training arguments
-training_args = TrainingArguments(
+training_args = ORTTrainingArguments(
    output_dir="path/to/save/folder/",
-   optim = "adamw_hf",
+   optim="adamw_ort_fused",
    ...
)

# Step 2: Create your ONNX Runtime Trainer
-trainer = Trainer(
+trainer = ORTTrainer(
    model=model,
    args=training_args,
    train_dataset=train_dataset,
+   feature="text-classification",
    ...
)

# Step 3: Use ONNX Runtime for training!ğŸ¤—
trainer.train()
```

ØªØ­Ù‚Ù‚ Ù…Ù† [Ù†ØµÙˆØµ Ø§Ù„Ù…Ø«Ø§Ù„](https://github.com/huggingface/optimum/tree/main/examples/onnxruntime/training) Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹ ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ Optimum.

## ORTSeq2SeqTrainer

ØªØ´Ø¨Ù‡ ÙØ¦Ø© [`ORTSeq2SeqTrainer`] ÙØ¦Ø© [`Seq2SeqTrainer`](https://huggingface.co/docs/transformers/main/en/main_classes/trainer#transformers.Seq2SeqTrainer)

Ù…Ù† Transformers. ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø³Ù‡ÙˆÙ„Ø© ØªÙƒÙŠÙŠÙ Ø§Ù„Ø±Ù…ÙˆØ² Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ `Seq2SeqTrainer` Ù…Ù† transformers Ø¨Ù€ `ORTSeq2SeqTrainer` Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ø§Ù„ØªØ³Ø±ÙŠØ¹

Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ù…Ù† ONNX Runtime. ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ÙƒÙŠÙÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… `ORTSeq2SeqTrainer` Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨Ù€ `Seq2SeqTrainer`:

```diff
-from transformers import Seq2SeqTrainer, Seq2SeqTrainingArguments
+from optimum.onnxruntime import ORTSeq2SeqTrainer, ORTSeq2SeqTrainingArguments

# Step 1: Define training arguments
-training_args = Seq2SeqTrainingArguments(
+training_args = ORTSeq2SeqTrainingArguments(
    output_dir="path/to/save/folder/",
-   optim = "adamw_hf",
+   optim="adamw_ort_fused",
    ...
)

# Step 2: Create your ONNX Runtime Seq2SeqTrainer
-trainer = Seq2SeqTrainer(
+trainer = ORTSeq2SeqTrainer(
    model=model,
    args=training_args,
    train_dataset=train_dataset,
+   feature="text2text-generation",
    ...
)

# Step 3: Use ONNX Runtime for training!ğŸ¤—
trainer.train()
```

ØªØ­Ù‚Ù‚ Ù…Ù† [Ù†ØµÙˆØµ Ø§Ù„Ù…Ø«Ø§Ù„](https://github.com/huggingface/optimum/tree/main/examples/onnxruntime/training) Ø§Ù„Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹ ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ Optimum.

## ORTTrainingArguments

ØªØ±Ø« ÙØ¦Ø© [`ORTTrainingArguments`] ÙØ¦Ø© [`TrainingArguments`](https://huggingface.co/docs/transformers/main/en/main_classes/trainer#transformers.TrainingArguments)

ÙÙŠ Transformers. Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø³Ù†Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© ÙÙŠ TransformersØŒ ÙØ¥Ù†Ù‡ ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© ÙÙŠ ONNX Runtime.

Ø§Ø³ØªØ¨Ø¯Ù„ `Seq2SeqTrainingArguments` Ø¨Ù€ `ORTSeq2SeqTrainingArguments`:

```diff
-from transformers import TrainingArguments
+from optimum.onnxruntime import ORTTrainingArguments

-training_args = TrainingArguments(
+training_args =  ORTTrainingArguments(
    output_dir="path/to/save/folder/",
    num_train_epochs=1,
    per_device_train_batch_size=8,
    per_device_eval_batch_size=8,
    warmup_steps=500,
    weight_decay=0.01,
    logging_dir="path/to/save/folder/",
-   optim = "adamw_hf",
+   optim="adamw_ort_fused",  # Fused Adam optimizer implemented by ORT
)
```

<Tip warning={false}>
ØªØ¯Ø¹Ù… ONNX Runtime DeepSpeed (ÙÙ‚Ø· ZeRO stage 1 Ùˆ 2 ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ).

ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ [Ø£Ù…Ø«Ù„Ø© ØªÙƒÙˆÙŠÙ† DeepSpeed](https://github.com/huggingface/optimum/tree/main/tests/onnxruntime/ds_configs)

ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ Optimum.
</Tip>

## ORTSeq2SeqTrainingArguments

ØªØ±Ø« ÙØ¦Ø© [`ORTSeq2SeqTrainingArguments`] ÙØ¦Ø© [`Seq2SeqTrainingArguments`](https://huggingface.co/docs/transformers/main/en/main_classes/trainer#transformers.Seq2SeqTrainingArguments)

ÙÙŠ Transformers. Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø³Ù†Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© ÙÙŠ TransformersØŒ ÙØ¥Ù†Ù‡ ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù†Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© ÙÙŠ ONNX Runtime.

Ø§Ø³ØªØ¨Ø¯Ù„ `Seq2SeqTrainingArguments` Ø¨Ù€ `ORTSeq2SeqTrainingArguments`:

```diff
-from transformers import Seq2SeqTrainingArguments
+from optimum.onnxruntime import ORTSeq2SeqTrainingArguments

-training_args = Seq2SeqTrainingArguments(
+training_args =  ORTSeq2SeqTrainingArguments(
    output_dir="path/to/save/folder/",
    num_train_epochs=1,
    per_device_train_batch_size=8,
    per_device_eval_batch_size=8,
    warmup_steps=500,
    weight_decay=0.01,
    logging_dir="path/to/save/folder/",
-   optim = "adamw_hf",
+   optim="adamw_ort_fused",  # Fused Adam optimizer implemented by ORT
)
```

<Tip warning={false}>
ØªØ¯Ø¹Ù… ONNX Runtime DeepSpeed (ÙÙ‚Ø· ZeRO stage 1 Ùˆ 2 ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ).

ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨Ø¹Ø¶ [Ø£Ù…Ø«Ù„Ø© ØªÙƒÙˆÙŠÙ† DeepSpeed](https://github.com/huggingface/optimum/tree/main/tests/onnxruntime/ds_configs)

ÙÙŠ Ù…Ø³ØªÙˆØ¯Ø¹ Optimum.
</Tip>

## ORTModule+StableDiffusion

ÙŠØ¯Ø¹Ù… Optimum ØªØ³Ø±ÙŠØ¹ Hugging Face Diffusers Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ONNX Runtime ÙÙŠ [Ù‡Ø°Ø§ Ø§Ù„Ù…Ø«Ø§Ù„](https://github.com/huggingface/optimum/tree/main/examples/onnxruntime/training/stable-diffusion/text-to-image).

ÙÙŠÙ…Ø§ ÙŠÙ„ÙŠ Ù…Ù„Ø®Øµ Ù„Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„ØªÙ…ÙƒÙŠÙ† ONNX Runtime Training:

```diff
import torch
from diffusers import AutoencoderKL, UNet2DConditionModel
from transformers import CLIPTextModel

+from onnxruntime.training.ortmodule import ORTModule
+from onnxruntime.training.optim.fp16_optimizer import FP16_Optimizer as ORT_FP16_Optimizer

unet = UNet2DConditionModel.from_pretrained(
    "CompVis/stable-diffusion-v1-4", 
    subfolder="unet",
    ...
)
text_encoder = CLIPTextModel.from_pretrained(
    "CompVis/stable-diffusion-v1-4", 
    subfolder="text_encoder",
    ...
)
vae = AutoencoderKL.from_pretrained(
    "CompVis/stable-diffusion-v1-4", 
    subfolder="vae",
    ...
)

optimizer = torch.optim.AdamW(
    unet.parameters(),
    ...
)

+vae = ORTModule(vae)
+text_encoder = ORTModule(text_encoder)
+unet = ORTModule(unet)

+optimizer = ORT_FP16_Optimizer(optimizer)
```
## Ù…ÙˆØ§Ø±Ø¯ Ø£Ø®Ø±Ù‰:

* ØªØ¯ÙˆÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©:
* [Optimum + ONNX Runtime: Easier, Faster training for your Hugging Face models](https://huggingface.co/blog/optimum-onnxruntime-training)
* ØªØ³Ø±ÙŠØ¹ ØªØ¯Ø±ÙŠØ¨ Ù†Ù…Ø§Ø°Ø¬ Ù…Ø­ÙˆÙ„Ø§Øª PyTorch Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ONNX Runtime - Ù†Ø¸Ø±Ø© Ø¹Ù…ÙŠÙ‚Ø©](https://techcommunity.microsoft.com/t5/ai-machine-learning-blog/accelerate-pytorch-transformer-model-training-with-onnx-runtime/ba-p/2540471)
* [Ù†Ø¸Ø±Ø© ÙÙ†ÙŠØ© Ù…ØªØ¹Ù…Ù‚Ø© Ø¹Ù„Ù‰ ONNX Runtime Training](https://techcommunity.microsoft.com/t5/ai-machine-learning-blog/onnx-runtime-training-technical-deep-dive/ba-p/1398310)
* [Ù…Ø³ØªÙˆØ¯Ø¹ Optimum Ø¹Ù„Ù‰ GitHub](https://github.com/huggingface/optimum)
* [Ù…Ø³ØªÙˆØ¯Ø¹ ONNX Runtime Ø¹Ù„Ù‰ GitHub](https://github.com/microsoft/onnxruntime)
* [Ù…Ø³ØªÙˆØ¯Ø¹ Torch ORT Ø¹Ù„Ù‰ GitHub](https://github.com/pytorch/ort)
* [ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø© Ù…Ù† ONNX Runtime](https://download.onnxruntime.ai/)

Ø¥Ø°Ø§ ÙˆØ§Ø¬Ù‡ØªÙƒ Ø£ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø£Ùˆ Ø£Ø³Ø¦Ù„Ø© ØªØªØ¹Ù„Ù‚ Ø¨Ù€ `ORTTrainer`ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ù…Ø´ÙƒÙ„Ø© Ø¥Ù„Ù‰ [Ù…Ø³ØªÙˆØ¯Ø¹ Optimum Ø¹Ù„Ù‰ GitHub](https://github.com/huggingface/optimum) Ø£Ùˆ Ù…Ù†Ø§Ù‚Ø´ØªÙ‡Ø§ Ù…Ø¹Ù†Ø§ Ø¹Ù„Ù‰ [Ù…Ù†ØªØ¯Ù‰ Ù…Ø¬ØªÙ…Ø¹ Hugging Face](https://discuss.huggingface.co/c/optimum/)ØŒ ØªØ­ÙŠØ§ØªÙŠ ğŸ¤— !