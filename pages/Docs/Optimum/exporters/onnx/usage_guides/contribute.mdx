# ุฅุถุงูุฉ ุฏุนู ูุจููุฉ ุบูุฑ ูุฏุนููุฉ

ุฅุฐุง ููุช ุชุฑุบุจ ูู ุชุตุฏูุฑ ูููุฐุฌ ูุง ุชุฏุนูู ุงูููุชุจุฉ ุญุงูููุงุ ูุฅููู ุงูุฎุทูุงุช ุงูุฑุฆูุณูุฉ ุงูุชู ูุฌุจ ุงุชุจุงุนูุง:

1. ุชูููุฐ ุชูููู ONNX ูุฎุตุต.
2. ูู ุจุชุณุฌูู ุชูููู ONNX ูู [`~optimum.exporters.TasksManager`].
3. ูู ุจุชุตุฏูุฑ ุงููููุฐุฌ ุฅูู ONNX.
4. ุงูุชุญูู ูู ุตุญุฉ ุงูุฅุฎุฑุงุฌ ูููููุฐุฌ ุงูุฃุตูู ูุงููุตุฏูุฑ.

ูู ูุฐุง ุงููุณูุ ุณูููู ูุธุฑุฉ ุนูู ููููุฉ ุชูููุฐ BERT ูุฅุธูุงุฑ ูุง ููุทูู ุนููู ูู ุฎุทูุฉ.

## ุชูููุฐ ุชูููู ONNX ูุฎุตุต

ููุจุฏุฃ ูุน ูุงุฆู ุชูููู ONNX. ููุฏู [ุชุณูุณู ูุฑูู ููุตููู](/exporters/onnx/package_reference/configuration) ูู ุซูุงุซุฉ ูุณุชููุงุชุ ููุฅุถุงูุฉ ุงูุฏุนู ููููุฐุฌ ูุงุ ุณูููู ุงูุชูุงุฑุซ ูู ุตู ุงููุฆุฉ ุงููุชูุณุทุฉ ูู ุงูุทุฑููุฉ ุงูุตุญูุญุฉ ูู ูุนุธู ุงูุฃุญูุงู. ูุฏ ุชุญุชุงุฌ ุฅูู ุชูููุฐ ูุฆุฉ ูุชูุณุทุฉ ุจููุณู ุฅุฐุง ููุช ุชุถูู ุจููุฉ ููุนุงูุฌุฉ ุทุฑููุฉ ุฃู ุญุงูุฉ ูู ูุณุจู ุฑุคูุชูุง.

<Tip>

ุทุฑููุฉ ุฌูุฏุฉ ูุชูููุฐ ุชูููู ONNX ูุฎุตุต ูู ุงููุธุฑ ูู ุชูููุฐุงุช ุงูุชูููู ุงูููุฌูุฏุฉ ูู
ููู `optimum/exporters/onnx/model_configs.py`.

ุฃูุถูุงุ ุฅุฐุง ูุงูุช ุงูุจููุฉ ุงูุชู ุชุญุงูู ุฅุถุงูุชูุง (ููุงุซูุฉ ุฌุฏูุง) ูุจููุฉ ูุฏุนููุฉ ุจุงููุนู
(ุนูู ุณุจูู ุงููุซุงูุ ุฅุถุงูุฉ ุฏุนู ูู ALBERT ุนูุฏูุง ูููู BERT ูุฏุนูููุง ุจุงููุนู)ุ ููุฏ ูุนูู ุงูุชูุงุฑุซ ุงูุจุณูุท ูู ูุฐู ุงููุฆุฉ.

</Tip>

ุนูุฏ ุงูุชูุงุฑุซ ูู ูุฆุฉ ูุชูุณุทุฉุ ุงุจุญุซ ุนู ุงููุฆุฉ ุงูุชู ุชุชุนุงูู ูุน ููุณ ุทุฑููุฉ / ูุฆุฉ ุงูููุงุฐุฌ ุงูุชู ุชุญุงูู ุฏุนููุง.

### ูุซุงู: ุฅุถุงูุฉ ุงูุฏุนู ูู BERT

ูุธุฑูุง ูุฃู BERT ูู ูููุฐุฌ ุชุฑููุฒ ูุนุชูุฏ ุนูู ุงููุตุ ูุฅูู ูุฑุซ ุชููููู ูู ูุฆุฉ ุงููุณุชูู ุงููุชูุณุท [`~optimum.exporters.onnx.config.TextEncoderOnnxConfig`].

ูู `optimum/exporters/onnx/model_configs.py`:

```python
# ุชูุน ูุฐู ุงููุฆุฉ ุจุงููุนู ูู optimum/exporters/onnx/config.py
class TextEncoderOnnxConfig(OnnxConfig):
# ูุตู ููููุฉ ุฅูุดุงุก ุฅุฏุฎุงูุงุช ููููุฉ.
DUMMY_INPUT_GENERATOR_CLASSES = (DummyTextInputGenerator,)

class BertOnnxConfig(TextEncoderOnnxConfig):
# ูุญุฏุฏ ููููุฉ ุชุทุจูุน BertConfigุ ููู ูุทููุจ ูููุตูู ุฅูู ุงูุณูุงุช ุงูุดุงุฆุนุฉ
# ุฃุซูุงุก ุชูููุฏ ุงูุฅุฏุฎุงู ุงููููู.
NORMALIZED_CONFIG_CLASS = NormalizedTextConfig
# ูุญุฏุฏ ุงูุชุณุงูุญ ุงููุทูู ุนูุฏ ุงูุชุญูู ูู ุตุญุฉ ูููุฐุฌ ONNX ุงููุตุฏุฑ
# ููุงุจู ุงููููุฐุฌ ุงููุฑุฌุนู.
ATOL_FOR_VALIDATION = 1e-4

@property
def inputs(self) -> Dict[str, Dict[int, str]]:
if self.task == "multiple-choice":
dynamic_axis = {0: "batch_size", 1: "num_choices", 2: "sequence_length"}
else:
dynamic_axis = {0: "batch_size", 1: "sequence_length"}
return {
"input_ids": dynamic_axis,
"attention_mask": dynamic_axis,
"token_type_ids": dynamic_axis,
}
```

ุฃููุงูุ ุฏุนูุง ูุดุฑุญ ูุง `TextEncoderOnnxConfig` ูู ูู ุดูุก. ูู ุญูู ุฃู ูุนุธู ุงูููุฒุงุช ูุชู ุชูููุฐูุง ุจุงููุนู ูู `OnnxConfig`ุ
ูุฐู ุงููุฆุฉ ูุง ุนูุงูุฉ ููุง ุจุงูุทุฑููุฉุ ููุฐุง ูุนูู ุฃููุง ูุง ุชุนุฑู ููุน ุงูุฅุฏุฎุงูุงุช ุงูุชู ูุฌุจ ุฃู ุชุชุนุงูู ูุนูุง. ุชุชู ูุนุงูุฌุฉ ุทุฑููุฉ ุฅูุดุงุก ุงูุฅุฏุฎุงู
ุนุจุฑ `DUMMY_INPUT_GENERATOR_CLASSES` ุงูุณูุฉุ ูุงูุชู ูู ุนุจุงุฑุฉ ุนู ูุฌููุนุฉ ูู [`~optimum.utils.input_generators.DummyInputGenerator`]s.
ููุง ูููู ุจุฅูุดุงุก ุชูููู ูุงุนู ุจุงูุทุฑููุฉ ูุฑุซ ูู `OnnxConfig` ุนู ุทุฑูู ุชุญุฏูุฏ
`DUMMY_INPUT_GENERATOR_CLASSES = (DummyTextInputGenerator,)`.

ุซู ูุฃุชู ูุฆุฉ ูุญุฏุฏุฉ ูููููุฐุฌุ `BertOnnxConfig`. ูุชู ุชุญุฏูุฏ ุณูุฉ ูุฆุฉ ุงุซููู ููุง:

- `NORMALIZED_CONFIG_CLASS`: ูุฌุจ ุฃู ูููู ูุฐุง [`~optimum.utils.normalized_config.NormalizedConfig`]ุ ููู ูุณูุญ
ูููุฏ ุงูุฅุฏุฎุงู ูููุตูู ุฅูู ุณูุงุช ุชูููู ุงููููุฐุฌ ุจุทุฑููุฉ ุนุงูุฉ.
- `ATOL_FOR_VALIDATION`: ูุชู ุงุณุชุฎุฏุงูู ููุชุญูู ูู ุตุญุฉ ุงููููุฐุฌ ุงููุตุฏุฑ ููุงุจู ุงูุฃุตููุ ููุฐุง ูู
ุงูุชุณุงูุญ ุงููุทูู ุงูููุจูู ูุงุฎุชูุงู ููู ุงูุฅุฎุฑุงุฌ.

ูุฌุจ ุฃู ูููู ูุงุฆู ุงูุชูููู ุจุชูููุฐ ุฎุงุตูุฉ [`~optimum.exporters.onnx.OnnxConfig.inputs`] ูุฅุฑุฌุงุน ุฎุฑูุทุฉุ ุญูุซ ูุชูุงูู ูู ููุชุงุญ ูุน ุงุณู ุฅุฏุฎุงูุ ููุดูุฑ ูู ูููุฉ ุฅูู ุงููุญุงูุฑ ุงูุฏููุงููููุฉ ูู ูุฐุง ุงูุฅุฏุฎุงู.

ุจุงููุณุจุฉ ูู BERTุ ูููููุง ุฃู ูุฑู ุฃู ููุงู ุซูุงุซุฉ ูุฏุฎูุงุช ูุทููุจุฉ: `input_ids`ุ `attention_mask` ู`token_type_ids`.
ูุฐู ุงูุฅุฏุฎุงูุงุช ููุง ููุณ ุงูุดูู `(batch_sizeุ sequence_length)` (ุจุงุณุชุซูุงุก ูููุฉ `multiple-choice`)ุ ูููุฐุง ุงูุณุจุจ ูุฑู ููุณ ุงููุญุงูุฑ ุงููุณุชุฎุฏูุฉ ูู ุงูุชูููู.

ุจูุฌุฑุฏ ุชูููุฐ ุชูููู ONNXุ ููููู ุฅูุดุงุก ูุซูู ููู ุนู ุทุฑูู ุชูููุฑ ุชูููู ุงููููุฐุฌ ุงูุฃุณุงุณู ููุง ููู:

```python
>>> from transformers import AutoConfig
>>> from optimum.exporters.onnx.model_configs import BertOnnxConfig
>>> config = AutoConfig.from_pretrained("bert-base-uncased")
>>> onnx_config = BertOnnxConfig(config)
```

ูุญุชูู ุงููุงุฆู ุงููุงุชุฌ ุนูู ุงูุนุฏูุฏ ูู ุงูุฎุตุงุฆุต ุงููููุฏุฉ. ุนูู ุณุจูู ุงููุซุงูุ ููููู ุนุฑุถ ูุฌููุนุฉ ูุดุบูู ONNX ุงูุชู ุณูุชู ุงุณุชุฎุฏุงููุง ุฃุซูุงุก ุงูุชุตุฏูุฑ:

```python
>>> print(onnx_config.DEFAULT_ONNX_OPSET)
11
```

ููููู ุฃูุถูุง ุนุฑุถ ุงูุฅุฎุฑุงุฌ ุงููุฑุชุจุท ุจุงููููุฐุฌ ููุง ููู:

```python
>>> print(onnx_config.outputs)
OrderedDict([('last_hidden_state', {0: 'batch_size', 1: 'sequence_length'})])
```

ูุงุญุธ ุฃู ุฎุงุตูุฉ ุงูุฅุฎุฑุงุฌ ุชุชุจุน ููุณ ุจููุฉ ุงูุฅุฏุฎุงูุงุชุ ููู ูุนูุฏ `OrderedDict` ูู ุงูุฅุฎุฑุงุฌ ุงููุณูู ูุฃุดูุงููู. ุชุฑุชุจุท ุจููุฉ ุงูุฅุฎุฑุงุฌ
ุจุงุฎุชูุงุฑ ุงููููุฉ ุงูุชู ูุชู ุชููุฆุฉ ุงูุชูููู ุจูุง. ุจุดูู ุงูุชุฑุงุถูุ ูุชู ุชููุฆุฉ ุชูููู ONNX ุจุงููููุฉ `default` ุงูุชู ุชุชูุงูู ูุน ุชุตุฏูุฑ
ูููุฐุฌ ูุญูู ุจุงุณุชุฎุฏุงู ูุฆุฉ `AutoModel`. ุฅุฐุง ููุช ุชุฑูุฏ ุชุตุฏูุฑ ูููุฐุฌ ููููุฉ ุฃุฎุฑูุ ููู ููุท ุจุชูููุฑ ูููุฉ ูุฎุชููุฉ ููุญุฌุฉ `task` ุนูุฏ ุชููุฆุฉ ุชูููู ONNX. ุนูู ุณุจูู ุงููุซุงูุ ุฅุฐุง ููุง ูุฑุบุจ ูู ุชุตุฏูุฑ BERT ุจุฑุฃุณ ุชุตููู ุชุณูุณูุ ููููููุง ุงุณุชุฎุฏุงู ูุง ููู:

```python
>>> from transformers import AutoConfig

>>> config = AutoConfig.from_pretrained("bert-base-uncased")
>>> onnx_config_for_seq_clf = BertOnnxConfig(config, task="text-classification")
>>> print(onnx_config_for_seq_clf.outputs)
OrderedDict([('logits', {0: 'batch_size'})])
```

<Tip>

ุชุญูู ูู [`BartOnnxConfig`] ููุซุงู ูุชูุฏู.

</Tip>

## ุชุณุฌูู ุชูููู ONNX ูู TasksManager

[`~optimum.exporters.tasks.TasksManager`] ูู ููุทุฉ ุงูุฏุฎูู ุงูุฑุฆูุณูุฉ ูุชุญููู ูููุฐุฌ ูุนูู ุจุงุณู ููููุฉุ
ูููุญุตูู ุนูู ุงูุชูููู ุงูุตุญูุญ ูุฒูุฌ (ุจููุฉุ ุฎูููุฉ). ุนูุฏ ุฅุถุงูุฉ ุงูุฏุนู ููุชุตุฏูุฑ ุฅูู ONNXุ
ุณูุคุฏู ุชุณุฌูู ุงูุชูููู ูู `TasksManager` ุฅูู ุฌุนู ุงูุชุตุฏูุฑ ูุชุงุญูุง ูู ุฃุฏุงุฉ ุณุทุฑ ุงูุฃูุงูุฑ.

ููููุงู ุจุฐููุ ุฃุถู ุฅุฏุฎุงูุงู ูู ุณูุฉ `_SUPPORTED_MODEL_TYPE`:

- ุฅุฐุง ูุงู ุงููููุฐุฌ ูุฏุนูููุง ุจุงููุนู ูุฎูููุงุช ุฃุฎุฑู ุบูุฑ ONNXุ ูุณูุชู ุฅุฏุฎุงูู ุจุงููุนูุ ูุฐูู ุณุชุญุชุงุฌ ููุท ุฅูู
ุฃุถู ููุชุงุญ "onnx" ุงูุฐู ูุญุฏุฏ ุงุณู ูุฆุฉ ุงูุชูููู.
- ูุฅูุงุ ูุณูุชุนูู ุนููู ุฅุถุงูุฉ ุงูุฅุฏุฎุงู ุจุงููุงูู.

ุจุงููุณุจุฉ ูู BERTุ ูุจุฏู ุงูุฃูุฑ ููุง ููู:

```python
"bert": supported_tasks_mapping(
"default",
"fill-mask",
"text-generation",
"text-classification",
"multiple-choice",
"token-classification",
"question-answering",
onnx="BertOnnxConfig",
)
```

## ุชุตุฏูุฑ ุงููููุฐุฌ

ุจูุฌุฑุฏ ุชูููุฐ ุชูููู ONNXุ ุชุชูุซู ุงูุฎุทูุฉ ุงูุชุงููุฉ ูู ุชุตุฏูุฑ ุงููููุฐุฌ.
ูููููุง ููุง ุงุณุชุฎุฏุงู ูุธููุฉ `export()` ุงูุชู ุชููุฑูุง ุญุฒูุฉ `optimum.exporters.onnx`.
ุชุชููุน ูุฐู ุงููุธููุฉ ุชูููู ONNXุ ุฅูู ุฌุงูุจ ุงููููุฐุฌ ุงูุฃุณุงุณูุ ููุณุงุฑ ุญูุธ ุงูููู ุงููุตุฏุฑ:

```python
>>> from pathlib import Path
>>> from optimum.exporters import TasksManager
>>> from optimum.exporters.onnx import export
>>> from transformers import AutoModel

>>> base_model = AutoModel.from_pretrained("bert-base-uncased")

>>> onnx_path = Path("model.onnx")
>>> onnx_config_constructor = TasksManager.get_exporter_config_constructor("onnx"ุ base_model)
>>> onnx_config = onnx_config_constructor(base_model.config)

>>> onnx_inputsุ onnx_outputs = export(base_model, onnx_config, onnx_path, onnx_config.DEFAULT_ONNX_OPSET)
```

`onnx_inputs` ู`onnx_outputs` ุงูุชู ุชุนูุฏูุง ูุธููุฉ `export()` ูู ููุงุฆู ุจุงูููุงุชูุญ ุงููุญุฏุฏุฉ ูู ุฎุตุงุฆุต [`~optimum.exporters.onnx.OnnxConfig.inputs`]
ู [`~optimum.exporters.onnx.OnnxConfig.inputs`] ูู ุงูุชูููู. ุจูุฌุฑุฏ ุชุตุฏูุฑ ุงููููุฐุฌุ ููููู ุงุฎุชุจุงุฑ ูุง ุฅุฐุง ูุงู ุงููููุฐุฌ ุฌูุฏ ุงูุชุดููู ููุง ููู:

```python
>>> import onnx

>>> onnx_model = onnx.load("model.onnx")
>>> onnx.checker.check_model(onnx_model)
```

<Tip>

ุฅุฐุง ูุงู ูููุฐุฌู ุฃูุจุฑ ูู 2 ุฌูุฌุงุจุงูุชุ ูุณุชูุงุญุธ ุฃูู ูุชู ุฅูุดุงุก ุงูุนุฏูุฏ ูู ุงููููุงุช ุงูุฅุถุงููุฉ ุฃุซูุงุก ุงูุชุตุฏูุฑ. ูุฐุง
ูุชููุน ูุฃู ONNX ูุณุชุฎุฏู [ุจุฑูุชูููู ุงููุฎุงุฒู ุงููุคูุชุฉ](https://developers.google.com/protocol-buffers/) ูุชุฎุฒูู ุงููููุฐุฌ
ููุฏููุง ุญุฏ ุญุฌู ูุจูุบ 2 ุฌูุฌุงุจุงูุช. ุฑุงุฌุน [ูุซุงุฆู ONNX](https://github.com/onnx/onnx/blob/master/docs/ExternalData.md)
ููุญุตูู ุนูู ุชุนูููุงุช ุญูู ููููุฉ ุชุญููู ุงูููุงุฐุฌ ุฐุงุช ุงูุจูุงูุงุช ุงูุฎุงุฑุฌูุฉ.

</Tip>

## ุงูุชุญูู ูู ุตุญุฉ ุฅุฎุฑุงุฌ ุงููููุฐุฌ

ุงูุฎุทูุฉ ุงูุฃุฎูุฑุฉ ูู ุงูุชุญูู ูู ุตุญุฉ ุงูุฅุฎุฑุงุฌ ูู ุงููููุฐุฌ ุงูุฃุณุงุณู ูุงููุตุฏุฑ
ุชุชูู ุถูู ุจุนุถ ุงูุชุณุงูุญ ุงููุทูู.
ูููููุง ููุง ุงุณุชุฎุฏุงู ูุธููุฉ `validate_model_outputs()` ุงูุชู ุชููุฑูุง ุญุฒูุฉ `optimum.exporters.onnx`:

```python
>>> from optimum.exporters.onnx import validate_model_outputs

>>> validate_model_outputs(
... onnx_config, base_model, onnx_path, onnx_outputs, onnx_config.ATOL_FOR_VALIDATION
... )
```

## ุงููุณุงููุฉ ูู ุงูุชูููู ุงูุฌุฏูุฏ ูู ๐ค Optimum

ุงูุขู ุจุนุฏ ุชูููุฐ ุฏุนู ุงูุจููุฉ ูุงูุชุญูู ูู ุตุญุชูุงุ ููุงู ุฃูุฑุงู ูุชุจููุงู:

1. ุฃุถู ุจููุฉ ูููุฐุฌู ุฅูู ุงูุงุฎุชุจุงุฑุงุช ูู `tests/exporters/test_onnx_export.py`
2. ุฅูุดุงุก ุทูุจ ุณุญุจ ุนูู [`ูุณุชูุฏุน Optimum`](https://github.com/huggingface/optimum)

ุดูุฑูุง ููุณุงููุชู!